import { useFormik } from 'formik';
import { memo, useRef } from 'react';
import { Form, Row, Card } from 'react-bootstrap';
import { useTranslation } from 'react-i18next';
import { useNavigate, useParams, useSearchParams } from 'react-router';
import * as Yup from 'yup';

import AsyncSelectField from '../../components/Common/AsyncSelectField';
import FormActionButtons from '../../components/Common/FormActionButtons';
import Input from '../../components/Common/Input';
import NumberField from '../../components/Common/NumberField';
import { useAdd{{capitalizedPageName}}, useUpdate{{capitalizedPageName}} } from '../../queries/{{pageName}}s_query';

const {{capitalizedPageName}}sForm = ({ isEdit = false, rowData = {} }) => {
  const submitActionRef = useRef(null);

  const { t } = useTranslation();
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { id } = useParams();

  const add{{capitalizedPageName}}Mutation = useAdd{{capitalizedPageName}}();
  const update{{capitalizedPageName}}Mutation = useUpdate{{capitalizedPageName}}();

  // Build validation schema dynamically
  const validationSchema = Yup.object().shape({
    {{#each columns}}
    {{this.name}}: Yup.{{#if (eq this.type 'Number')}}number(){{else if (eq this.type 'Boolean')}}boolean(){{else}}string(){{/if}}.required(t('field_required')),
    {{/each}}
  });

  const formik = useFormik({
    initialValues: {
      {{#each columns}}
      {{this.name}}: {{#if (eq this.type 'Boolean')}}isEdit ? !!rowData.{{this.name}} : false{{else}}isEdit ? rowData.{{this.name}} || '' : ''{{/if}},
      {{/each}}
    },
    validationSchema,
    enableReinitialize: true,

    onSubmit: async (values, { setSubmitting }) => {
      try {
        let {{pageName}}Id;

        if (isEdit) {
          await update{{capitalizedPageName}}Mutation.mutateAsync({
            {{#if (ne primaryKey 'id')}}
            {{primaryKey}}: id || rowData.{{primaryKey}},
            {{else}}
            id: id || rowData.id,
            {{/if}}
            ...values,
          });
          {{pageName}}Id = id || rowData.{{primaryKey}};
        } else {
          const result = await add{{capitalizedPageName}}Mutation.mutateAsync(values);
          {{pageName}}Id = result?.{{primaryKey}};
        }

        if (submitActionRef.current === 'close') {
          navigate(-1);
        }

        if (submitActionRef.current === 'view') {
          const search = searchParams.toString();
          navigate(
            {{pageName}}Id ? `/{{pageName}}s/${ {{pageName}}Id }${search ? `?${search}` : ''}` : `/{{pageName}}s${search ? `?${search}` : ''}`
          );
        }
      } catch {
        // Error handling is managed globally by QueryProvider
      } finally {
        setSubmitting(false);
        submitActionRef.current = null;
      }
    },
  });

  const handleSaveAndClose = () => {
    submitActionRef.current = 'close';
    formik.submitForm();
  };

  const handleSaveAndView = () => {
    submitActionRef.current = 'view';
    formik.submitForm();
  };

  const handleCancel = () => {
    navigate(-1);
  };

  const isMutationPending =
    add{{capitalizedPageName}}Mutation.isPending || update{{capitalizedPageName}}Mutation.isPending;

  return (
    <Card>
      <Card.Body>
        <Form noValidate onSubmit={formik.handleSubmit}>
          <Row>
            {{#each columns}}
            {{#if (eq this.type 'Number')}}
            <NumberField
              formik={formik}
              fieldId={'{{this.name}}'}
              label={t('{{this.label}}')}
            />
            {{else if (eq this.type 'Boolean')}}
            <Input
              type="checkbox"
              formik={formik}
              fieldId={'{{this.name}}'}
              label={t('{{this.label}}')}
            />
            {{else if (eq this.type 'Select')}}
            <AsyncSelectField
              formik={formik}
              fieldId={'{{this.name}}'}
              label={t('{{this.label}}')}
              // TODO: Add options for this select field
            />
            {{else}}
            <Input formik={formik} fieldId={'{{this.name}}'} label={t('{{this.label}}')} />
            {{/if}}
            {{/each}}
          </Row>

          <FormActionButtons
            isSubmitting={formik.isSubmitting}
            isPending={isMutationPending}
            isEdit={isEdit}
            isValid={formik.isValid}
            dirty={formik.dirty}
            onCancel={handleCancel}
            onSaveAndClose={handleSaveAndClose}
            onSaveAndView={handleSaveAndView}
          />
        </Form>
      </Card.Body>
    </Card>
  );
};

export default memo({{capitalizedPageName}}sForm);